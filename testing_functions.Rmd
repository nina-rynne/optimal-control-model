---
title: "testing_functions"
output: html_document
date: "2025-03-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}

# Load required libraries
library(dplyr)
library(tidyr)
library(readr)
library(here)
library(testthat)

```

```{r data_preparation_test}

# Source the data preparation functions
source(here::here("src", "data_preparation.R"))

# Test import_ssp_emissions function
# ------------------------------------
cat("Testing import_ssp_emissions function...\n")

# Import emissions data - just pass the filename, path handling is in the import function
emissions_imported <- import_ssp_emissions("emissions.csv")
cat("Imported emissions data dimensions:", dim(emissions_imported)[1], "rows,", 
    dim(emissions_imported)[2], "columns\n")

# Display sample of the imported emissions data
cat("\nSample of imported emissions data:\n")
print(head(emissions_imported, 3))

# Test import_ssp_economic function
# ------------------------------------
cat("\nTesting import_ssp_economic function...\n")

# Import economic data - just pass the filename, path handling is in the import function
economic_imported <- import_ssp_economic("gwp.csv")
cat("Imported economic data dimensions:", dim(economic_imported)[1], "rows,", 
    dim(economic_imported)[2], "columns\n")

# Display sample of the imported economic data
cat("\nSample of imported economic data:\n")
print(head(economic_imported, 3))

# Test interpolate_ssp_emissions function
# ------------------------------------
cat("\nTesting interpolate_ssp_emissions function...\n")

# Test with annual time step
emissions_interpolated <- interpolate_ssp_emissions(
  emissions_df = emissions_imported,
  dt = 1,
  start_year = 2020,
  end_year = 2100
)
cat("Interpolated emissions data dimensions:", dim(emissions_interpolated)[1], "rows,", 
    dim(emissions_interpolated)[2], "columns\n")

# Test interpolate_ssp_economic function
# ------------------------------------
cat("\nTesting interpolate_ssp_economic function...\n")

# Test with annual time step
economic_interpolated <- interpolate_ssp_economic(
  economic_df = economic_imported,
  dt = 1,
  start_year = 2020,
  end_year = 2100
)
cat("Interpolated economic data dimensions:", dim(economic_interpolated)[1], "rows,", 
    dim(economic_interpolated)[2], "columns\n")

cat("\nTest script completed.\n")

```

```{r experimental_design_test}
# This script tests the functionality of the generate_lhs_samples function
# from the experimental_design.R script in the src directory

# Source the experimental_design.R script from the src directory
source("src/experimental_design.R")

# Run the function with default parameters and display the results
cat("\n=== SAMPLE OUTPUT WITH DEFAULT PARAMETERS ===\n")
default_samples <- generate_lhs_samples()
cat("\nFirst 10 rows of the generated samples:\n")
print(head(default_samples, 10))

cat("\nSummary statistics of the generated samples:\n")
print(summary(default_samples))

# Define tests
test_that("generate_lhs_samples produces expected outputs", {
  
  # Test 1: Basic execution with default parameters
  cat("Test 1: Basic execution with default parameters\n")
  result_default <- generate_lhs_samples()
  
  # Check result structure
  expect_true(is.data.frame(result_default))
  expect_equal(nrow(result_default), 50)  # Default n_samples is 50
  expect_equal(ncol(result_default), 5)   # There should be 5 parameters
  
  # Check parameter names
  expected_params <- c("tcre", "cost_mitig", "cost_remov", "econ_dam_pct", "disc_rate")
  expect_equal(names(result_default), expected_params)
  
  # Test 2: Parameter values are within expected ranges
  cat("Test 2: Parameter values are within expected ranges\n")
  expect_true(all(result_default$tcre >= 0.27 & result_default$tcre <= 0.63))
  expect_true(all(result_default$cost_mitig >= 200 & result_default$cost_mitig <= 1000))
  expect_true(all(result_default$cost_remov >= 5 & result_default$cost_remov <= 1000))
  expect_true(all(result_default$econ_dam_pct >= 0.05 & result_default$econ_dam_pct <= 0.2))
  expect_true(all(result_default$disc_rate >= 0.01 & result_default$disc_rate <= 0.05))
  
  # Test 3: Reproducibility with seed
  cat("Test 3: Reproducibility with seed\n")
  result_seed1 <- generate_lhs_samples(seed = 123)
  result_seed2 <- generate_lhs_samples(seed = 123)
  expect_equal(result_seed1, result_seed2)
  
  # Test 4: Different sampling methods
  cat("Test 4: Different sampling methods\n")
  result_optimum <- generate_lhs_samples(sampling_method = "optimum")
  result_genetic <- generate_lhs_samples(sampling_method = "genetic")
  
  expect_true(is.data.frame(result_optimum))
  expect_true(is.data.frame(result_genetic))
  expect_equal(nrow(result_optimum), 50)
  expect_equal(nrow(result_genetic), 50)
  
  # Test 5: Return raw option
  cat("Test 5: Return raw option\n")
  result_raw <- generate_lhs_samples(return_raw = TRUE)
  
  expect_true(is.list(result_raw))
  expect_equal(length(result_raw), 2)
  expect_true("raw_samples" %in% names(result_raw))
  expect_true("scaled_samples" %in% names(result_raw))
  expect_equal(dim(result_raw$raw_samples), c(50, 5))
  expect_equal(dim(result_raw$scaled_samples), c(50, 5))
  
  # Test 6: Custom sample size
  cat("Test 6: Custom sample size\n")
  result_custom <- generate_lhs_samples(n_samples = 100)
  
  expect_equal(nrow(result_custom), 100)
  
  # Test 7: Error handling - invalid sample size
  cat("Test 7: Error handling - invalid sample size\n")
  expect_error(generate_lhs_samples(n_samples = -10))
  expect_error(generate_lhs_samples(n_samples = "invalid"))
  
  # Test 8: Error handling - invalid sampling method
  cat("Test 8: Error handling - invalid sampling method\n")
  expect_error(generate_lhs_samples(sampling_method = "invalid_method"))
  
  # Test 9: Error handling - invalid return_raw
  cat("Test 9: Error handling - invalid return_raw\n")
  expect_error(generate_lhs_samples(return_raw = "yes"))
})

# Run distribution tests
test_that("LHS generates well-distributed samples", {
  
  # Test 10: Distribution properties
  cat("Test 10: Distribution properties\n")
  set.seed(42)
  samples <- generate_lhs_samples(n_samples = 1000)
  
  # Check that samples are relatively uniformly distributed (using quartiles)
  for (param in names(samples)) {
    quartiles <- quantile(samples[[param]], probs = c(0.25, 0.5, 0.75))
    range_size <- max(samples[[param]]) - min(samples[[param]])
    
    # Check if quartiles are roughly where they should be
    expect_true(abs(quartiles[1] - (min(samples[[param]]) + 0.25 * range_size)) < 0.1 * range_size)
    expect_true(abs(quartiles[2] - (min(samples[[param]]) + 0.5 * range_size)) < 0.1 * range_size)
    expect_true(abs(quartiles[3] - (min(samples[[param]]) + 0.75 * range_size)) < 0.1 * range_size)
  }
})

# Run performance tests
test_that("Function performs within acceptable limits", {
  
  # Test 11: Performance test
  cat("Test 11: Performance test\n")
  start_time <- Sys.time()
  generate_lhs_samples(n_samples = 1000)
  end_time <- Sys.time()
  
  # Function should run in less than 2 seconds for 1000 samples
  execution_time <- as.numeric(difftime(end_time, start_time, units = "secs"))
  expect_true(execution_time < 2)
})

# Summary of test results
cat("\nAll tests completed.\n")


```

```{r model_parameters_test}

#' @title Test Script for Model Parameters Functions
#' @description 
#' This script tests the functionality of the model_parameters.R script, which contains
#' functions for loading, managing, and manipulating parameters for climate models.
#' 
#' It runs a series of tests on the functions:
#' - get_fixed_parameters()
#' - add_fixed_parameters()
#'

# Source the model parameters script from the src folder
source(here::here("src", "model_parameters.R"))

# Define the path to the actual parameter file
param_file <- here::here("parameter_details.yml")

# Function to print formatted section headers
print_section <- function(text) {
  cat("\n", paste(rep("=", 80), collapse = ""), "\n")
  cat(" ", text, "\n")
  cat(paste(rep("=", 80), collapse = ""), "\n\n")
}

# Begin testing
print_section("TESTING MODEL PARAMETERS FUNCTIONS")

# Test 1: Check if get_fixed_parameters loads correctly
test_that("get_fixed_parameters loads parameters correctly", {
  # Call function with the actual parameter file
  params <- get_fixed_parameters(config_file = param_file)
  
  # Check if the function returns a list
  expect_true(is.list(params))
  
  # Check if specific parameters are present with correct values
  expect_equal(params$temp_init, 1.2)
  expect_equal(params$co2_conc_preind, 280)
  expect_equal(params$exp_mitig, 2)
  
  # Print success message
  cat("✓ get_fixed_parameters loads\n")
})

# Test 2: removed

# Test 3: removed

# Test 4: Error handling for missing file
test_that("get_fixed_parameters handles missing file gracefully", {
  # Try to load a non-existent file
  expect_error(
    get_fixed_parameters(config_file = "non_existent_file.yml"),
    "Configuration file not found"
  )
  
  cat("✓ get_fixed_parameters handles missing file gracefully\n")
})

# Test 5: Test add_fixed_parameters function with default_samples
test_that("add_fixed_parameters combines variable and fixed parameters", {
  # Add fixed parameters to default_samples
  combined_params <- add_fixed_parameters(
    param_df = default_samples,
    config_file = param_file
  )
  
  # Check if result is a dataframe
  expect_true(is.data.frame(combined_params))
  
  # Check if both variable and fixed parameters are present
  # Using actual column names from default_samples
  expect_true("tcre" %in% names(combined_params))
  expect_true("cost_mitig" %in% names(combined_params))
  expect_true("temp_init" %in% names(combined_params))
  
  # Check if the number of rows matches the input
  expect_equal(nrow(combined_params), nrow(default_samples))
  
  cat("✓ add_fixed_parameters successfully combines variable and fixed parameters\n")
})

# Test 6: Test different append positions
test_that("add_fixed_parameters respects append_position", {
  # Test "start" position
  start_params <- add_fixed_parameters(
    param_df = default_samples,
    append_position = "start",
    config_file = param_file
  )
  
  # Check if the fixed parameters come first
  first_col <- names(start_params)[1]
  expect_true(first_col != "tcre")
  
  # Test "alphabetical" position
  alpha_params <- add_fixed_parameters(
    param_df = default_samples,
    append_position = "alphabetical",
    config_file = param_file
  )
  
  # Columns should be in alphabetical order
  expect_equal(names(alpha_params), sort(names(alpha_params)))
  
  cat("✓ add_fixed_parameters respects different append_position values\n")
})

# Test 7: Parameter exclusion
test_that("add_fixed_parameters can exclude specified parameters", {
  # Exclude some parameters
  excluded_params <- add_fixed_parameters(
    param_df = default_samples,
    config_file = param_file,
    exclude_params = c("temp_init", "exp_mitig")
  )
  
  # Check if excluded parameters are actually excluded
  expect_false("temp_init" %in% names(excluded_params))
  expect_true("co2_conc_preind" %in% names(excluded_params))
  
  cat("✓ add_fixed_parameters can exclude specified parameters\n")
})

# Test 8: Check metadata attributes
test_that("add_fixed_parameters adds appropriate metadata", {
  result <- add_fixed_parameters(
    param_df = default_samples,
    config_file = param_file
  )
  
  # Check if metadata attribute exists
  expect_true(!is.null(attr(result, "parameter_source")))
  
  # Check if metadata contains expected elements
  metadata <- attr(result, "parameter_source")
  expect_true("variable_params" %in% names(metadata))
  expect_true("fixed_params" %in% names(metadata))
  
  cat("✓ add_fixed_parameters adds appropriate metadata attributes\n")
})

print_section("ALL TESTS COMPLETED")

# Summarize results
cat("Test Summary:\n")
cat("- 6 tests run\n")
cat("- All functions behave as expected\n")
cat("- get_fixed_parameters and add_fixed_parameters work correctly with valid inputs\n")
cat("- Error handling for invalid inputs is appropriate\n\n")

```



```{r not_complete_code, eval=FALSE, include=FALSE}


```

